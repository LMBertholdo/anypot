#!/usr/bin/env python
# -*- coding: utf-8 -*-

import socket
import string
import binascii

from ntp_.outMonlist import Dict_Monlist as outMonlist

class Sig_Dict():

    dict_qt = dict()
    dict_monlist = dict()

    monlist_out_data = [outMonlist.outMonlist1,outMonlist.outMonlist2,outMonlist.outMonlist3,outMonlist.outMonlist4,outMonlist.outMonlist5,outMonlist.outMonlist6,outMonlist.outMonlist7,outMonlist.outMonlist8,outMonlist.outMonlist9,outMonlist.outMonlist10,outMonlist.outMonlist11,outMonlist.outMonlist12,outMonlist.outMonlist13,outMonlist.outMonlist14,outMonlist.outMonlist15,outMonlist.outMonlist16,outMonlist.outMonlist17,outMonlist.outMonlist18,outMonlist.outMonlist19,outMonlist.outMonlist20,outMonlist.outMonlist21,outMonlist.outMonlist22,outMonlist.outMonlist23,outMonlist.outMonlist24,outMonlist.outMonlist25,outMonlist.outMonlist26,outMonlist.outMonlist27,outMonlist.outMonlist28,outMonlist.outMonlist29]

class Signature(object):
    """
    Build all dicts with the respective data
    """
    def __init__(self, my_logger):
        self.my_logger = my_logger

    def make_dict_monlist(self):
        for i in range(0,28):
            Sig_Dict.dict_monlist[i] = (Sig_Dict.monlist_out_data[i])

    def make_dict(self):
        #basic error message
        self.out_server_error = b'\x97\x00\x03*@\x00\x00\x00'

        self.in_server_monlist = b'\x17\x00\x03*\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'

        #NTP server response for monlist
        self.make_dict_monlist()

        self.in_server_reslist =  b'\x17\x00\x03\x10\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'

        self.out_server_reslist = b'\xd7\x01\x03*\x00\x06\x00H\x00\x02D\x8d\x00\x04-\xdb\x00\x00\x00\x00\x00\x00\x00\x15\xc0\xa8\x05\x8c\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04:\x04\x00\x04:\x04\x00\x00\x00\x00\x00\x00\x00\x01\n\x14\xd7O\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\n#\x1b\x00\x04@w\x00\x00\x00\x00\x00\x00\x00\x02\n\x14\xd7j\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02"\x8e\x00\x04@\xe5\x00\x00\x00\x00\x00\x00\x00\x02\n\x14\xd7w\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\'"\x00\x04NC\x00\x00\x00\x00\x00\x00\x00\x02\xc0\xa8\x01\x19\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xa3\xae\x00\x04V\xc4\x00\x00\x00\x00\x00\x00\x00\x1d\n\x14\x1e\x82\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'

        self.in_server_mru = b'\x16\x0c\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00'

        self.out_server_mru = b'\xd7\x02\x03*\x00\x06\x00H\x00\x03\xa7\xec\x00\x04nD\x00\x00\x00\x00\x00\x00\x00\r\xc0\xa8\x06R\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\xa3\xae\x00\x04p\xd0\x00\x00\x00\x00\x00\x00\x00\x12\xc0\xa8\x03\x1b\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf7\xc0\x00\x04xT\x00\x00\x00\x00\x00\x00\x001\xc0\xa8\x04]\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\xf8:\x00\x04\x844\x00\x00\x00\x00\x00\x00\x00\x10\xc0\xa8\x05O\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x05\x15\x04\x00\x04\x8a\xc9\x00\x00\x00\x00\x00\x00\x00\x06\xc0\xa8\x03\xf2\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xd3\xf7\x00\x04\x8f\xce\x00\x00\x00\x00\x00\x00\x00\x1a\xc0\xa8\x03\xa1\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'

        self.in_server_peers = b'\x16\x0c\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00'

        self.out_server_peers = b'\xd7\x03\x03*\x00\x06\x00H\x00\x02(\xfb\x00\x04\x90U\x00\x00\x00\x00\x00\x00\x00\x16\xc0\xa8\x06\xd9\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\xe4\xe5\x00\x04\x90\xfc\x00\x00\x00\x00\x00\x00\x00\x10\xc0\xa8\x05\xf1\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\xf86\x00\x04\x91\x00\x00\x00\x00\x00\x00\x00\x00\x10\xc0\xa8\x06E\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\xfd\xbe\x00\x04\x91\x16\x00\x00\x00\x00\x00\x00\x00\r\xc0\xa8\x04\xd5\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x80O\x00\x04\x91a\x00\x00\x00\x00\x00\x00\x00\x13\xc0\xa8\x06M\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x10\xfb\x00\x04\x91m\x00\x00\x00\x00\x00\x00\x00\x17\xc0\xa8\x07\x9a\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'

        self.in_server_peers_two = b'\x16\x01\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00'

        self.out_server_peers_two = b'\xd7\x03\x03*\x00\x06\x00H\x00\x02(\xfb\x00\x04\x90U\x00\x00\x00\x00\x00\x00\x00\x16\xc0\xa8\x06\xd9\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\xe4\xe5\x00\x04\x90\xfc\x00\x00\x00\x00\x00\x00\x00\x10\xc0\xa8\x05\xf1\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\xf86\x00\x04\x91\x00\x00\x00\x00\x00\x00\x00\x00\x10\xc0\xa8\x06E\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\xfd\xbe\x00\x04\x91\x16\x00\x00\x00\x00\x00\x00\x00\r\xc0\xa8\x04\xd5\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x80O\x00\x04\x91a\x00\x00\x00\x00\x00\x00\x00\x13\xc0\xa8\x06M\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x10\xfb\x00\x04\x91m\x00\x00\x00\x00\x00\x00\x00\x17\xc0\xa8\x07\x9a\xc0\xa8\x00\xfd\x00\x00\x00\x01\x00{\x03\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'

        Sig_Dict.dict_qt['error'] = (self.out_server_error)
        Sig_Dict.dict_qt[self.in_server_reslist] = (self.out_server_reslist)
        Sig_Dict.dict_qt[self.in_server_mru] = (self.out_server_mru)
        Sig_Dict.dict_qt[self.in_server_peers] = (self.out_server_peers)
        Sig_Dict.dict_qt[self.in_server_peers_two] = (self.out_server_peers_two)

    def build(self):
        self.make_dict()

    def just_monlist(self, addr, socket_t):
        for i in range(0,28):
            socket_t.sendto(bytes(Sig_Dict.dict_monlist[i]),addr)
            #print(Sig_Dict.dict_monlist[i])

    def resolve_question(self, data, addr, socket_t):
        #self.in_server_monlist is in the make_dict function
        if(data == self.in_server_monlist):
            self.just_monlist(addr, socket_t)
        else:
            try:
                rsp = Sig_Dict.dict_qt[data]
            except KeyError as a:
                print('NTP KeyError:',a)
                self.my_logger.critical('[NTP KeyError resolve_question function]' +str(a))
                #this way the server will respond with the default message error
                rsp = Sig_Dict.dict_qt['error']

            finally:
                socket_t.sendto(bytes(rsp),addr)
